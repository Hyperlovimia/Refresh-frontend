# grid-placement-rules 规范变更

## ADDED Requirements

### Requirement: 网格单元独占性

系统 SHALL 确保每个网格单元在任何时刻只包含一个元素。

#### Scenario: 单元素放置

- **WHEN** 用户在空网格单元放置任意元素
- **THEN** 系统在该单元格记录该元素
- **AND** 该单元格标记为已占用

#### Scenario: 阻止重复放置

- **WHEN** 用户尝试在已占用的网格单元放置新元素
- **AND** 未启用覆盖模式
- **THEN** 系统拒绝放置操作
- **AND** 提示用户该位置已被占用

### Requirement: 结构-家具互斥性

系统 SHALL 确保结构元素（墙、门、窗）和家具元素（风扇、椅子、桌子、床）不能共存于同一网格单元。

#### Scenario: 结构元素阻止家具放置

- **WHEN** 网格单元包含结构元素（墙、门或窗）
- **AND** 用户尝试在该单元放置家具元素
- **THEN** 系统拒绝放置操作
- **AND** 提示用户该位置已有结构元素

#### Scenario: 家具元素阻止结构放置

- **WHEN** 网格单元包含家具元素
- **AND** 用户尝试在该单元放置结构元素
- **THEN** 系统拒绝放置操作
- **AND** 提示用户该位置已有家具

### Requirement: 元素覆盖原则

系统 SHALL 在用户放置新元素时，自动替换同位置的现有元素。

#### Scenario: 同类型元素覆盖

- **WHEN** 用户在包含结构元素的单元放置新的结构元素
- **THEN** 系统移除原有结构元素
- **AND** 在该位置放置新结构元素

#### Scenario: 同类型家具覆盖

- **WHEN** 用户在包含家具元素的单元放置新的家具元素
- **THEN** 系统移除原有家具元素
- **AND** 在该位置放置新家具元素

### Requirement: 房间内部家具限制

系统 SHALL 仅允许在标记为房间内部的网格单元放置家具元素。

#### Scenario: 房间内部允许家具

- **WHEN** 网格单元的 Room_Interior 属性为 true
- **AND** 用户尝试放置家具元素
- **THEN** 系统允许放置操作（假设无其他冲突）

#### Scenario: 房间外部拒绝家具

- **WHEN** 网格单元的 Room_Interior 属性为 false
- **AND** 用户尝试放置家具元素
- **THEN** 系统拒绝放置操作
- **AND** 提示用户家具只能放置在房间内部

#### Scenario: 房间内部状态变化触发验证

- **WHEN** 网格单元的 Room_Interior 属性从 true 变为 false
- **AND** 该单元包含家具元素
- **THEN** 系统标记该家具为无效状态
- **AND** 提示用户需要移除或移动该家具

### Requirement: 多格元素原子化移除

系统 SHALL 在移除或替换多格元素（桌子、床）时，完整清除该元素占用的所有网格单元。

#### Scenario: 完整移除多格元素

- **WHEN** 用户删除一个多格元素（桌子或床）
- **THEN** 系统识别该元素占用的所有网格单元
- **AND** 同时清除所有这些单元的占用状态
- **AND** 不留下任何部分残留

#### Scenario: 覆盖多格元素

- **WHEN** 用户在多格元素占用的任一单元放置新元素
- **THEN** 系统完整移除原有多格元素
- **AND** 清除该多格元素占用的所有单元
- **AND** 在目标位置放置新元素

#### Scenario: 多格元素边界验证

- **WHEN** 用户尝试放置多格元素
- **AND** 该元素的任一占用单元超出画布边界
- **THEN** 系统拒绝放置操作
- **AND** 提示用户元素超出边界

### Requirement: 多格元素完整性保持

系统 SHALL 确保多格元素在任何操作后保持完整，不产生"空洞"或部分元素。

#### Scenario: 防止部分覆盖

- **WHEN** 操作可能导致多格元素部分被覆盖
- **THEN** 系统完整移除该多格元素
- **AND** 确保不留下部分单元仍被标记为占用

#### Scenario: 旋转边界检查

- **WHEN** 用户旋转多格元素
- **AND** 旋转后的尺寸超出画布边界
- **THEN** 系统拒绝旋转操作
- **AND** 保持元素原有状态和位置

### Requirement: 放置验证反馈

系统 SHALL 为所有放置操作提供清晰的验证结果和错误反馈。

#### Scenario: 成功放置反馈

- **WHEN** 放置操作成功
- **THEN** 系统返回成功状态
- **AND** 包含放置的元素信息
- **AND** 包含被移除的元素列表（如有覆盖）

#### Scenario: 失败放置反馈

- **WHEN** 放置操作失败
- **THEN** 系统返回失败状态
- **AND** 提供具体的错误类型（超出边界、房间内部违规、元素冲突）
- **AND** 提供用户可理解的错误消息

#### Scenario: 边界错误反馈

- **WHEN** 元素放置超出画布边界
- **THEN** 系统返回 OutOfBoundsError
- **AND** 错误消息说明元素超出边界

#### Scenario: 房间内部违规反馈

- **WHEN** 家具放置在房间外部
- **THEN** 系统返回 RoomInteriorViolationError
- **AND** 错误消息说明家具只能放置在房间内部
