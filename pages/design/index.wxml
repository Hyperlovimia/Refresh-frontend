<!-- æˆ¿é—´è®¾è®¡é¡µé¢ -->
<view class="design-page">
  <!-- é¡¶éƒ¨æ“ä½œæ  -->
  <view class="top-bar">
    <view class="top-bar-left">
      <text class="page-title">æˆ¿é—´è®¾è®¡</text>
    </view>
    <view class="top-bar-right">
      <t-button size="small" theme="primary" bind:tap="onSave" class="btn-action">ä¿å­˜</t-button>
      <t-button size="small" theme="default" bind:tap="onLoadDesign" class="btn-action">åŠ è½½</t-button>
    </view>
  </view>

  <!-- ä¸»å†…å®¹åŒº -->
  <view class="main-content">
    <!-- å·¦ä¾§å·¥å…·æ  -->
    <view class="toolbar">
      <!-- å›¾å±‚åˆ‡æ¢ -->
      <view class="tool-section">
        <text class="section-title">å›¾å±‚</text>
        <view class="layer-switch">
          <view
            class="layer-item {{currentLayer === 'base' ? 'active' : ''}}"
            data-layer="base"
            bind:tap="onSwitchLayer"
          >
            <text class="layer-name">åŸºç¡€</text>
          </view>
          <view
            class="layer-item {{currentLayer === 'furniture' ? 'active' : ''}}"
            data-layer="furniture"
            bind:tap="onSwitchLayer"
          >
            <text class="layer-name">å®¶å…·</text>
          </view>
          <view
            class="layer-item {{currentLayer === 'overlay' ? 'active' : ''}}"
            data-layer="overlay"
            bind:tap="onSwitchLayer"
          >
            <text class="layer-name">å åŠ </text>
          </view>
        </view>
      </view>

      <view class="tool-section" wx:if="{{currentLayer === 'base'}}">
        <text class="section-title">åŸºç¡€å·¥å…·</text>
        <view
          class="tool-item {{currentTool === 'wall' ? 'active' : ''}}"
          data-tool="wall"
          bind:tap="onSelectTool"
        >
          <text class="tool-icon">ğŸ§±</text>
          <text class="tool-name">å¢™å£</text>
        </view>
        <view
          class="tool-item {{currentTool === 'room' ? 'active' : ''}}"
          data-tool="room"
          bind:tap="onSelectTool"
        >
          <text class="tool-icon">â¬œ</text>
          <text class="tool-name">æˆ¿é—´</text>
        </view>
        <view
          class="tool-item {{currentTool === 'door' ? 'active' : ''}}"
          data-tool="door"
          bind:tap="onSelectTool"
        >
          <text class="tool-icon">ğŸšª</text>
          <text class="tool-name">é—¨</text>
        </view>
        <view
          class="tool-item {{currentTool === 'window' ? 'active' : ''}}"
          data-tool="window"
          bind:tap="onSelectTool"
        >
          <text class="tool-icon">ğŸªŸ</text>
          <text class="tool-name">çª—æˆ·</text>
        </view>
      </view>

      <!-- å®¶å…·å±‚å·¥å…· -->
      <view class="tool-section" wx:if="{{currentLayer === 'furniture'}}">
        <text class="section-title">å®¶å…·</text>
        <view
          class="tool-item {{currentTool === 'fan' ? 'active' : ''}}"
          data-tool="fan"
          bind:tap="onSelectTool"
        >
          <text class="tool-icon">ğŸŒ€</text>
          <text class="tool-name">é£æ‰‡</text>
        </view>
        <view
          class="tool-item {{currentTool === 'chair' ? 'active' : ''}}"
          data-tool="chair"
          bind:tap="onSelectTool"
        >
          <text class="tool-icon">ğŸª‘</text>
          <text class="tool-name">æ¤…å­</text>
        </view>
        <view
          class="tool-item {{currentTool === 'table' ? 'active' : ''}}"
          data-tool="table"
          bind:tap="onSelectTool"
        >
          <text class="tool-icon">ğŸª‘</text>
          <text class="tool-name">æ¡Œå­</text>
        </view>
        <view
          class="tool-item {{currentTool === 'bed' ? 'active' : ''}}"
          data-tool="bed"
          bind:tap="onSelectTool"
        >
          <text class="tool-icon">ğŸ›ï¸</text>
          <text class="tool-name">åºŠ</text>
        </view>
      </view>

      <!-- å åŠ å±‚å·¥å…· -->
      <view class="tool-section overlay-tools" wx:if="{{currentLayer === 'overlay'}}">
        <text class="section-title">åˆ†æ</text>
        <view
          class="tool-item tool-item-load-analysis"
          bind:tap="onLoadAnalysis"
        >
          <text class="tool-icon">ğŸ“Š</text>
          <text class="tool-name">åŠ è½½åˆ†æ</text>
        </view>
        <view
          class="tool-item tool-item-clear-heatmap"
          wx:if="{{designData.overlay_layer.heatmap}}"
          bind:tap="onClearHeatmap"
        >
          <text class="tool-icon">ğŸ§¹</text>
          <text class="tool-name">æ¸…é™¤çƒ­åŠ›å›¾</text>
        </view>
      </view>

      <view class="tool-section">
        <text class="section-title">æ“ä½œ</text>
        <view
          class="tool-item {{currentTool === 'select' ? 'active' : ''}}"
          data-tool="select"
          bind:tap="onSelectTool"
        >
          <text class="tool-icon">ğŸ‘†</text>
          <text class="tool-name">é€‰æ‹©</text>
        </view>
        <view
          class="tool-item"
          bind:tap="onDelete"
        >
          <text class="tool-icon">ğŸ—‘ï¸</text>
          <text class="tool-name">åˆ é™¤</text>
        </view>
        <view
          class="tool-item"
          wx:if="{{currentLayer === 'furniture' && selectedElement}}"
          bind:tap="onRotate"
        >
          <text class="tool-icon">ğŸ”„</text>
          <text class="tool-name">æ—‹è½¬</text>
        </view>
        <view
          class="tool-item"
          bind:tap="onToggleGrid"
        >
          <text class="tool-icon">{{showGrid ? 'â˜‘ï¸' : 'â¬œ'}}</text>
          <text class="tool-name">ç½‘æ ¼</text>
        </view>
      </view>
    </view>

    <!-- å³ä¾§ç”»å¸ƒåŒºåŸŸ -->
    <view class="canvas-container">
      <canvas
        type="2d"
        id="designCanvas"
        class="design-canvas"
        bindtouchstart="onTouchStart"
        bindtouchmove="onTouchMove"
        bindtouchend="onTouchEnd"
      ></canvas>

      <!-- åæ ‡æ˜¾ç¤º -->
      <view class="coord-display" wx:if="{{currentCoord}}">
        åæ ‡: ({{currentCoord.x}}, {{currentCoord.y}})
        <text wx:if="{{currentHeatmapValue}}">
          | å€¼: {{currentHeatmapValue.value.toFixed(1)}}{{currentHeatmapValue.unit}}
        </text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨çŠ¶æ€æ  -->
  <view class="status-bar">
    <text>å½“å‰å·¥å…·: {{toolNames[currentTool] || 'æ— '}}</text>
    <text wx:if="{{selectedElement}}">é€‰ä¸­: {{selectedElement.type}}</text>
    <text wx:if="{{currentLayer === 'overlay' && designData.overlay_layer.heatmap}}">
      å€¼èŒƒå›´: {{designData.overlay_layer.heatmap.minValue.toFixed(1)}}{{designData.overlay_layer.heatmap.unit}} - {{designData.overlay_layer.heatmap.maxValue.toFixed(1)}}{{designData.overlay_layer.heatmap.unit}}
    </text>
  </view>

  <!-- åŠ è½½è®¾è®¡æ–‡ä»¶å¯¹è¯æ¡† -->
  <t-dialog
    visible="{{showLoadDialog}}"
    title="é€‰æ‹©è®¾è®¡æ–‡ä»¶"
    confirm-btn="åŠ è½½"
    cancel-btn="å–æ¶ˆ"
    bind:confirm="onConfirmLoad"
    bind:cancel="onCancelLoad"
  >
    <view class="file-list">
      <view
        class="file-item {{selectedFile === item.name ? 'selected' : ''}}"
        wx:for="{{fileList}}"
        wx:key="name"
        data-filename="{{item.name}}"
        bind:tap="onSelectFile"
      >
        <text class="file-name">{{item.name}}</text>
        <text class="file-time">{{item.modified}}</text>
      </view>
      <view class="file-item empty" wx:if="{{fileList.length === 0}}">
        <text>æš‚æ— ä¿å­˜çš„è®¾è®¡æ–‡ä»¶</text>
      </view>
    </view>
  </t-dialog>

  <!-- Toastæç¤º -->
  <t-toast id="t-toast" />
</view>
